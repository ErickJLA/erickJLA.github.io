let app;
app = new Vue({
  el: '#app',
  data() {
    return {
      curveData: [],
      tableData: [],
      logMessages: [],
      currentLED: 'None',
      currentAbsorbance: 'N/A',
      deviceConnected: false // Add a Vue data property to track connection
    };
  },
  methods: {
    addCurveData(dataValue) {
      const newRow = {
        time: new Date().toLocaleTimeString('en-US', {
          hour12: false
        }),
        absorbance: parseFloat(dataValue),
        concentration: null
      };
      this.curveData.push(newRow);
    },
    addDataToTable(dataValue) {
      const newRow = {
        time: new Date().toLocaleTimeString('en-US', {
          hour12: false
        }),
        absorbance: parseFloat(dataValue),
        concentration: null
      };
      this.tableData.push(newRow);
    },
    addLog(message) {
      const newLog = {
        message: message,
        timestamp: new Date()
      };
      this.logMessages.push(newLog);
    },
    validateNumber(row) {
      const newValue = parseFloat(row.concentration);
      if (isNaN(newValue)) {
        row.concentration = isNaN(row.concentration) ? null : parseFloat(row.concentration);
      } else {
        row.concentration = newValue;
      }
    },
    updateAbsorbance(absorbance) {
      this.currentAbsorbance = absorbance;
    },
    updateLED(led) {
      this.currentLED = led;
    },
    setDeviceConnected(connected) { // New method to update Vue data
      this.deviceConnected = connected;
    }
  },
  watch: {
    currentLED(newVal) {
      $('#led-status').text(`LED: ${newVal}`);
    },
    currentAbsorbance(newVal) {
      $('#absorbance-status').text(`Absorbance: ${newVal}`);
    },
    deviceConnected(newVal) { // Watch for changes to deviceConnected
      if (newVal) {
        $('#connection-status').text('● Connected').addClass('connected');
      } else {
        $('#connection-status').text('● Disconnected').removeClass('connected');
      }
    }
  }
});

const connectButton = document.getElementById('connectButton');
const takeCurveReadingButton = document.getElementById('takeCurveReadingButton');
const takeSampleReadingButton = document.getElementById('takeSampleReadingButton');
const redLEDButton = document.getElementById('redLEDButton');
const greenLEDButton = document.getElementById('greenLEDButton');
const blueLEDButton = document.getElementById('blueLEDButton');
const setZeroProgressDiv = document.getElementById('set-zero-progress');
const progressBar = document.querySelector('#set-zero-progress .progress-bar');
const zeroPromptModal = $('#zeroPromptModal');
const setZeroConfirmation = document.getElementById('set-zero-confirmation');
const connectionStatus = document.getElementById('connection-status');

let device = null;
let characteristicTX = null;
let characteristicRX = null;
let zeroingInterval;
let connectionCheckInterval; // Store the interval ID

async function connect() {
  try {
    console.log('Requesting Bluetooth Device...');
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['79daf682-341b-42b5-891a-1647a8a9517b']
    });

    console.log('> Name:          ' + device.name);
    console.log('> Id:            ' + device.id);
    console.log('> Connected:     ' + device.gatt.connected);

    console.log('Connecting to GATT Server...');
    const server = await device.gatt.connect();

    console.log('Getting Service...');
    const service = await server.getPrimaryService('79daf682-341b-42b5-891a-1647a8a9517b');

    console.log('Getting Characteristics...');
    characteristicTX = await service.getCharacteristic('b6f055b0-cb3f-4c99-8098-2a793916bada');
    characteristicRX = await service.getCharacteristic('daa5f483-1420-4f26-9095-165d8fc6a321');

    await characteristicTX.startNotifications();
    characteristicTX.addEventListener('characteristicvaluechanged', handleIncomingData);
    console.log('Notifications enabled');

    connectButton.disabled = true;

    // Update Vue data and status bar
    app.setDeviceConnected(true);

    alert('Connected successfully!');

    // Start connection monitoring
    startConnectionMonitoring();

  } catch (error) {
    console.error('Error in connection process:', error);
    alert('Connection failed: ' + error.message);
  }
}

function handleIncomingData(event) {
  const value = new TextDecoder().decode(event.target.value);
  console.log('Received:', value);

  if (value.startsWith('d:')) {
    const dataValue = value.substring(2);
    const activeTab = document.querySelector('.nav-link.active').textContent;
    if (activeTab === 'Curve') {
      app.addCurveData(dataValue);
    } else if (activeTab === 'Samples') {
      app.addDataToTable(dataValue);
    } else {
      app.addLog('Data received but no active data table selected.');
    }
    app.updateAbsorbance(parseFloat(dataValue).toFixed(8));
  } else if (value.startsWith('a:')) {
    const absorbanceValue = parseFloat(value.substring(2)).toFixed(8);
    app.updateAbsorbance(absorbanceValue);
  } else {
    app.addLog(value);
  }
}

async function send(message) {
  if (message && characteristicRX) {
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(message);
      await characteristicRX.writeValue(data);
      console.log('Sent message:', message);
    } catch (error) {
      console.error('Error sending message:', error);
      statusDiv.textContent = 'Error sending message: ' + error.message;
    }
  }
}

function disconnect() { // Implement disconnect function
  if (device) {
    device.gatt.disconnect();
    app.setDeviceConnected(false); // Update Vue data
  }
}

function startConnectionMonitoring() {
  if (connectionCheckInterval) {
    clearInterval(connectionCheckInterval); // Clear any existing interval
  }

  connectionCheckInterval = setInterval(() => {
    if (device && !device.gatt.connected) {
      console.log('Device disconnected unexpectedly.');
      clearInterval(connectionCheckInterval); // Stop monitoring
      disconnect(); // Call disconnect to update UI
    }
  }, 2000); // Check every 2 seconds (adjust as needed)
}

connectButton.addEventListener('click', connect);

takeCurveReadingButton.addEventListener('click', () => {
  send('READ_SENSOR');
});

takeSampleReadingButton.addEventListener('click', () => {
  send('READ_SENSOR');
});

redLEDButton.addEventListener('click', () => {
  showZeroPrompt('Red');
});

greenLEDButton.addEventListener('click', () => {
  showZeroPrompt('Green');
});

blueLEDButton.addEventListener('click', () => {
  showZeroPrompt('Blue');
});

function showZeroPrompt(ledColor) {
  const promptMessage = `Insert blank sample and click OK to set zero with the ${ledColor} LED.`;
  $('#zeroPromptMessage').text(promptMessage);
  zeroPromptModal.modal('show');
  setZeroConfirmation.style.display = 'none';

  const okButton = document.getElementById('modal-ok-button');
  okButton.onclick = () => {
    send(`LED_${ledColor.toUpperCase()}_ON`);
    zeroPromptModal.modal('hide');
    app.updateLED(ledColor);
    app.updateAbsorbance('Setting...');
    startSetZeroProgress();
    setZeroProgressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);

    let progress = 0;
    zeroingInterval = setInterval(() => {
      progress += 10;
      progressBar.style.width = `${progress}%`;
      progressBar.setAttribute('aria-valuenow', progress);
      if (progress >= 100) {
        clearInterval(zeroingInterval);
        setTimeout(() => {
          setZeroProgressDiv.style.display = 'none';
          app.endSetZeroProgress();
          setZeroConfirmation.style.display = 'block';
          app.updateAbsorbance(app.currentAbsorbance);
        }, 500);
      }
    }, 500);
  };
}

// Periodic update (adjust interval as needed)
setInterval(() => {
  if (deviceConnected) {
    send('READ_SENSOR');
  }
}, 1000);
