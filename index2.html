<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Web Bluetooth</title>
  <style>
    body {
      font-family: sans-serif;
    }
    #status {
      margin-bottom: 10px;
      font-weight: bold;
    }
    #receivedData {
      margin-top: 20px;
      white-space: pre-wrap; /* Preserve formatting for received data */
    }
  </style>
</head>
<body>
  <h1>ESP32 Web Bluetooth</h1>
  <div id="status">Status: Not connected</div>

  <button id="connectButton">Connect</button>
  <button id="disconnectButton" disabled>Disconnect</button>

  <input type="text" id="messageInput" placeholder="Enter message">
  <button id="sendButton" disabled>Send</button>

  <div id="receivedData"></div>

  <script>
    const connectButton = document.getElementById('connectButton');
    const disconnectButton = document.getElementById('disconnectButton');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const statusDiv = document.getElementById('status');
    const receivedDataDiv = document.getElementById('receivedData');

    let device = null;
    let characteristicTX = null;
    let characteristicRX = null;

    async function connect() {
      try {
        statusDiv.textContent = 'Searching for device...';

        // Request Bluetooth device with the specified service UUID
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['79daf682-341b-42b5-891a-1647a8a9517b'] }],
          optionalServices: ['79daf682-341b-42b5-891a-1647a8a9517b'] // Include optional services
        });

        statusDiv.textContent = 'Connecting to device...';
        const server = await device.gatt.connect();

        statusDiv.textContent = 'Discovering services...';
        const service = await server.getPrimaryService('79daf682-341b-42b5-891a-1647a8a9517b');

        statusDiv.textContent = 'Getting characteristics...';
        characteristicTX = await service.getCharacteristic('daa5f483-1420-4f26-9095-165d8fc6a321');
        characteristicRX = await service.getCharacteristic('b6f055b0-cb3f-4c99-8098-2a793916bada');

        // Enable notifications for the TX characteristic
        await characteristicTX.startNotifications();
        characteristicTX.addEventListener('characteristicvaluechanged', handleIncomingData);

        statusDiv.textContent = 'Connected';
        connectButton.disabled = true;
        disconnectButton.disabled = false;
        sendButton.disabled = false;

      } catch (error) {
        statusDiv.textContent = 'Error: ' + error.message;
        console.error(error);
      }
    }

    function handleIncomingData(event) {
      const value = new TextDecoder().decode(event.target.value);
      receivedDataDiv.innerHTML += value + '<br>';
    }

    function disconnect() {
      if (device) {
        if (characteristicTX) {
          characteristicTX.removeEventListener('characteristicvaluechanged', handleIncomingData);
        }
        device.gatt.disconnect();
        device = null;
        characteristicTX = null;
        characteristicRX = null;

        statusDiv.textContent = 'Disconnected';
        connectButton.disabled = false;
        disconnectButton.disabled = true;
        sendButton.disabled = true;
      }
    }

    async function send() {
      const message = messageInput.value;
      if (message && characteristicRX) {
        try {
          const encoder = new TextEncoder();
          const data = encoder.encode(message);
          await characteristicRX.writeValue(data);
          messageInput.value = '';
        } catch (error) {
          statusDiv.textContent = 'Error sending message: ' + error.message;
          console.error(error);
        }
      }
    }

    connectButton.addEventListener('click', connect);
    disconnectButton.addEventListener('click', disconnect);
    sendButton.addEventListener('click', send);
  </script>
</body>
</html>
