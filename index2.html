<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Web Bluetooth</title>
  <style>
    body {
      font-family: sans-serif;
    }
    #status {
      margin-bottom: 10px;
      font-weight: bold;
    }
    #receivedData {
      margin-top: 20px;
      white-space: pre-wrap; /* Preserve formatting for received data */
    }
  </style>
</head>
<body>
  <h1>ESP32 Web Bluetooth</h1>
  <div id="status">Status: Not connected</div>

  <button id="connectButton">Connect</button>
  <button id="disconnectButton" disabled>Disconnect</button>

  <input type="text" id="messageInput" placeholder="Enter message">
  <button id="sendButton" disabled>Send</button>

  <div id="receivedData"></div>

  <script>
    const connectButton = document.getElementById('connectButton');
    const disconnectButton = document.getElementById('disconnectButton');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const statusDiv = document.getElementById('status');
    const receivedDataDiv = document.getElementById('receivedData');

    let device = null;
    let characteristicTX = null;
    let characteristicRX = null;

    async function connect() {
      try {
        console.log('Requesting Bluetooth Device...');
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true, // Still using the temporary change for debugging
          optionalServices: ['79daf682-341b-42b5-891a-1647a8a9517b']
        });

        console.log('> Name:             ' + device.name);
        console.log('> Id:               ' + device.id);
        console.log('> Connected:        ' + device.gatt.connected);

        console.log('Connecting to GATT Server...');
        const server = await device.gatt.connect();

        console.log('Getting Service...');
        const service = await server.getPrimaryService('79daf682-341b-42b5-891a-1647a8a9517b');

        console.log('Getting Characteristic...');
        characteristicTX = await service.getCharacteristic('daa5f483-1420-4f26-9095-165d8fc6a321');
        characteristicRX = await service.getCharacteristic('b6f055b0-cb3f-4c99-8098-2a793916bada');

        // Enable notifications for the TX characteristic
        await characteristicTX.startNotifications();
        characteristicTX.addEventListener('characteristicvaluechanged', handleIncomingData);
        console.log('Notifications enabled');

        statusDiv.textContent = 'Status: Connected';
        connectButton.disabled = true;
        disconnectButton.disabled = false;
        sendButton.disabled = false;

        alert('Connected successfully!');

      } catch (error) {
        console.error('Error in connection process:', error);
        alert('Connection failed: ' + error.message);
      }
    }

    function handleIncomingData(event) {
      const value = new TextDecoder().decode(event.target.value);
      console.log('Received:', value);
    }

    function disconnect() {
      if (device) {
        if (characteristicTX) {
          characteristicTX.removeEventListener('characteristicvaluechanged', handleIncomingData);
        }
        device.gatt.disconnect();
        device = null;
        characteristicTX = null;
        characteristicRX = null;

        statusDiv.textContent = 'Status: Disconnected';
        connectButton.disabled = false;
        disconnectButton.disabled = true;
        sendButton.disabled = true;
      }
    }

    async function send() {
      const message = messageInput.value;
      if (message && characteristicRX) {
        try {
          const encoder = new TextEncoder();
          const data = encoder.encode(message);

          // Chunk the data into smaller parts (e.g., 20 bytes each)
          const chunkSize = 20;
          for (let i = 0; i < data.length; i += chunkSize) {
            const chunk = data.slice(i, i + chunkSize);
            await characteristicRX.writeValue(chunk);
            console.log('Sent chunk:', chunk);

            // Introduce a delay after each write
            await delay(500); // Wait for 500 milliseconds (adjust as needed)
          }

          messageInput.value = '';
        } catch (error) {
          statusDiv.textContent = 'Error sending message: ' + error.message;
          console.error(error);
        }
      }
    }

    // Helper function to create a delay using Promises
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    connectButton.addEventListener('click', connect);
    disconnectButton.addEventListener('click', disconnect);
    sendButton.addEventListener('click', send);
  </script>
</body>
</html>
